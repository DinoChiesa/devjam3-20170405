<?xml version="1.0" encoding="UTF-8"?>
<ProxyEndpoint name="oauth2">
  <Description>Proxy Endpoint to handle OAuth 2.0 Authorization Code flow</Description>
  <HTTPProxyConnection>
    <BasePath>/devjam3/oauth2-ac</BasePath>
    <Properties/>
    <VirtualHost>secure</VirtualHost>
  </HTTPProxyConnection>

  <FaultRules/>

  <PreFlow name="PreFlow">
    <Request/>
    <Response/>
  </PreFlow>

  <PostFlow name="PostFlow">
    <Request/>
    <Response/>
  </PostFlow>

  <Flows>

    <Flow name="authorize_app">
      <Condition>(proxy.pathsuffix MatchesPath "/authorize") and (request.verb = "GET")</Condition>
      <Description/>
      <Request>
        <Step><Name>OAuthV2-GetInfo</Name></Step>
        <Step><Name>AM-AuthorizationSession</Name></Step>
        <Step><Name>CP-AuthorizationSession</Name></Step>
      </Request>
      <Response>
        <Step>
          <Name>AM-RedirectToLoginApp</Name>
        </Step>
      </Response>
    </Flow>

    <Flow name="authorization code">
      <Condition>(proxy.pathsuffix MatchesPath "/authcode") and (request.verb = "POST")</Condition>
      <Description/>
      <Request>
        <!--
          <Step>
            <Name>VerifyAPIKey</Name>
          </Step>
        -->
        <Step>
          <Name>CL-GetAuthzSession</Name>
        </Step>
        <Step>
          <Name>RF-BadSession</Name>
          <Condition>authtx = null</Condition>
        </Step>
        <Step>
          <Name>JS-ImportJsonToContext</Name>
        </Step>
        <Step>
          <Name>OAuthV2-GenerateAuthorizationCode</Name>
        </Step>
      </Request>
      <Response/>
    </Flow>


    <Flow name="token">
      <Condition>(proxy.pathsuffix MatchesPath "/token") and (request.verb = "POST")</Condition>
      <Description/>
      <Request>
        <Step>
          <Name>AM-DeleteForwardedHeaders</Name>
        </Step>
        <Step>
          <Name>OAuthV2-GenerateAccessToken</Name>
        </Step>
      </Request>
      <Response/>
    </Flow>

    <!--
    <Flow name="SampleAuthPage">
      <Condition>(proxy.pathsuffix MatchesPath "/sampleauthpage") and (request.verb = "GET")</Condition>
      <Description/>
      <Request>
        <Step>
          <Condition>request.queryparam.userId != "test" or request.queryparam.password != "password"</Condition>
          <Name>RF-InvalidUserCredentials</Name>
        </Step>
        <Step>
          <Condition>request.queryparam.userId = "test" and request.queryparam.password = "password"</Condition>
          <Name>sample.authpage.webserverflow</Name>
        </Step>
      </Request>
      <Response/>
    </Flow>

    <Flow name="SampleCallbackPage">
      <Condition>(proxy.pathsuffix MatchesPath "/samplecallbackpage") and (request.verb = "GET")</Condition>
      <Description/>
      <Request>
        <Step>
          <Name>sample.callbackpage.webserverflow</Name>
        </Step>
        <Step>
          <Name>sample.callbackpage.webserverflow</Name>
        </Step>
      </Request>
      <Response/>
    </Flow>
    -->

    <Flow name='unknown request'>
      <Request>
        <Step><Name>RF-UnknownRequest</Name></Step>
      </Request>
      <Response/>
    </Flow>

  </Flows>

  <RouteRule name="Login">
    <Condition>(proxy.pathsuffix MatchesPath "/login") and (request.verb = "GET")</Condition>
    <TargetEndpoint>login</TargetEndpoint>
  </RouteRule>

  <RouteRule name="NoRoute"/>

</ProxyEndpoint>
